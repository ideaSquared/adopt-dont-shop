# syntax=docker/dockerfile:1.4
# Enable BuildKit features for advanced caching and performance

# ============================================================================
# Industry Standard Monorepo Workspace Dockerfile
# ============================================================================
# Follows patterns used by Vercel, Google, and other tech giants
# Builds libraries once, references via npm workspace
# Usage: docker build --build-arg APP_NAME=app.client -f Dockerfile.app.optimized .

ARG NODE_VERSION=20
FROM node:${NODE_VERSION}-alpine AS base

WORKDIR /app

# Install necessary packages including wget for health checks
# hadolint ignore=DL3018
RUN apk add --no-cache \
    git=~2 \
    wget=~1 \
    dumb-init=~1

# Create non-root user for security
RUN addgroup -g 1001 -S nodejs && \
    adduser -S viteuser -u 1001

# Development stage
FROM base AS development
ARG APP_NAME

# Copy workspace configuration files for better caching
COPY --chown=viteuser:nodejs package*.json turbo.json ./

# Copy eslint-config packages (workspace dependencies needed for npm install)
COPY --chown=viteuser:nodejs eslint-config-base/ ./eslint-config-base/
COPY --chown=viteuser:nodejs eslint-config-react/ ./eslint-config-react/
COPY --chown=viteuser:nodejs eslint-config-node/ ./eslint-config-node/

# Copy library package.json files first (better layer caching)
COPY --chown=viteuser:nodejs lib.analytics/package.json ./lib.analytics/
COPY --chown=viteuser:nodejs lib.api/package.json ./lib.api/
COPY --chown=viteuser:nodejs lib.applications/package.json ./lib.applications/
COPY --chown=viteuser:nodejs lib.audit-logs/package.json ./lib.audit-logs/
COPY --chown=viteuser:nodejs lib.auth/package.json ./lib.auth/
COPY --chown=viteuser:nodejs lib.chat/package.json ./lib.chat/
COPY --chown=viteuser:nodejs lib.components/package.json ./lib.components/
COPY --chown=viteuser:nodejs lib.discovery/package.json ./lib.discovery/
COPY --chown=viteuser:nodejs lib.dev-tools/package.json ./lib.dev-tools/
COPY --chown=viteuser:nodejs lib.feature-flags/package.json ./lib.feature-flags/
COPY --chown=viteuser:nodejs lib.invitations/package.json ./lib.invitations/
COPY --chown=viteuser:nodejs lib.moderation/package.json ./lib.moderation/
COPY --chown=viteuser:nodejs lib.notifications/package.json ./lib.notifications/
COPY --chown=viteuser:nodejs lib.permissions/package.json ./lib.permissions/
COPY --chown=viteuser:nodejs lib.pets/package.json ./lib.pets/
COPY --chown=viteuser:nodejs lib.rescue/package.json ./lib.rescue/
COPY --chown=viteuser:nodejs lib.search/package.json ./lib.search/
COPY --chown=viteuser:nodejs lib.support-tickets/package.json ./lib.support-tickets/
COPY --chown=viteuser:nodejs lib.utils/package.json ./lib.utils/
COPY --chown=viteuser:nodejs lib.validation/package.json ./lib.validation/

# Copy app package.json
COPY --chown=viteuser:nodejs ${APP_NAME}/package.json ./${APP_NAME}/

# Install dependencies with BuildKit cache mount (this layer is cached unless package.json changes)
RUN --mount=type=cache,target=/root/.npm \
    npm ci --prefer-offline

# Copy all library source code
COPY --chown=viteuser:nodejs lib.analytics/ ./lib.analytics/
COPY --chown=viteuser:nodejs lib.api/ ./lib.api/
COPY --chown=viteuser:nodejs lib.applications/ ./lib.applications/
COPY --chown=viteuser:nodejs lib.audit-logs/ ./lib.audit-logs/
COPY --chown=viteuser:nodejs lib.auth/ ./lib.auth/
COPY --chown=viteuser:nodejs lib.chat/ ./lib.chat/
COPY --chown=viteuser:nodejs lib.components/ ./lib.components/
COPY --chown=viteuser:nodejs lib.discovery/ ./lib.discovery/
COPY --chown=viteuser:nodejs lib.dev-tools/ ./lib.dev-tools/
COPY --chown=viteuser:nodejs lib.feature-flags/ ./lib.feature-flags/
COPY --chown=viteuser:nodejs lib.invitations/ ./lib.invitations/
COPY --chown=viteuser:nodejs lib.moderation/ ./lib.moderation/
COPY --chown=viteuser:nodejs lib.notifications/ ./lib.notifications/
COPY --chown=viteuser:nodejs lib.permissions/ ./lib.permissions/
COPY --chown=viteuser:nodejs lib.pets/ ./lib.pets/
COPY --chown=viteuser:nodejs lib.rescue/ ./lib.rescue/
COPY --chown=viteuser:nodejs lib.search/ ./lib.search/
COPY --chown=viteuser:nodejs lib.support-tickets/ ./lib.support-tickets/
COPY --chown=viteuser:nodejs lib.utils/ ./lib.utils/
COPY --chown=viteuser:nodejs lib.validation/ ./lib.validation/

# Copy specific app source code
COPY --chown=viteuser:nodejs ${APP_NAME}/ ./${APP_NAME}/

# Switch to non-root user
USER viteuser

# Expose port
EXPOSE 3000

# Development command
WORKDIR /app/${APP_NAME}

# Use dumb-init for proper signal handling
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["npm", "run", "dev"]

# Build stage for production
FROM base AS build
ARG APP_NAME

# Copy entire workspace
COPY . .

# Install dependencies with cache mount
RUN --mount=type=cache,target=/root/.npm \
    npm ci --prefer-offline

# Build libraries first, then the specific app using Turbo
# Use cache mount for Turbo cache
# The '...' prefix builds all dependencies first, then the target app
# Set NODE_ENV=production to use "import" exports instead of "development" (src/*.ts)
RUN --mount=type=cache,target=/app/.turbo \
    NODE_ENV=production npx turbo run build --filter=...@adopt-dont-shop/${APP_NAME}

# ============================================================================
# PRODUCTION STAGE - Minimal Nginx image for static assets
# ============================================================================
FROM nginx:alpine AS production
ARG APP_NAME

# Install security updates
# hadolint ignore=DL3018
RUN apk update && apk upgrade && rm -rf /var/cache/apk/*

# Copy built app from build stage
COPY --from=build /app/${APP_NAME}/dist /usr/share/nginx/html

# Create optimized nginx config for SPA with security headers
RUN echo 'events { \
    worker_connections 1024; \
} \
http { \
    include /etc/nginx/mime.types; \
    default_type application/octet-stream; \
    \
    # Performance optimizations \
    sendfile on; \
    tcp_nopush on; \
    tcp_nodelay on; \
    keepalive_timeout 65; \
    types_hash_max_size 2048; \
    \
    # Gzip compression \
    gzip on; \
    gzip_vary on; \
    gzip_comp_level 6; \
    gzip_min_length 1000; \
    gzip_proxied any; \
    gzip_types text/plain text/css text/xml text/javascript \
               application/javascript application/xml+rss application/json \
               application/wasm; \
    \
    server { \
        listen 80; \
        server_name _; \
        root /usr/share/nginx/html; \
        index index.html; \
        \
        # Security headers (OWASP recommendations) \
        add_header X-Frame-Options "SAMEORIGIN" always; \
        add_header X-Content-Type-Options "nosniff" always; \
        add_header X-XSS-Protection "1; mode=block" always; \
        add_header Referrer-Policy "strict-origin-when-cross-origin" always; \
        \
        # SPA routing - all routes to index.html \
        location / { \
            try_files $uri $uri/ /index.html; \
        } \
        \
        # Static assets with long-term caching \
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ { \
            expires 1y; \
            add_header Cache-Control "public, immutable"; \
            access_log off; \
        } \
        \
        # Health check endpoint \
        location /health { \
            access_log off; \
            return 200 "healthy\n"; \
            add_header Content-Type text/plain; \
        } \
    } \
}' > /etc/nginx/nginx.conf

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

# Expose port
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]

# ============================================================================
# METADATA - OCI image-spec labels
# ============================================================================
LABEL org.opencontainers.image.title="Adopt Don't Shop - Frontend App"
LABEL org.opencontainers.image.description="React + Vite frontend application"
LABEL org.opencontainers.image.vendor="Adopt Don't Shop"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.source="https://github.com/ideaSquared/adopt-dont-shop"
